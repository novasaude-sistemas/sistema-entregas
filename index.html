<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Nova Saúde - Controle de Entregas</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root {
  --bg-dark: #020617;
  --card-dark: #0b1220;
  --accent: #2563eb;
}
html, body {
  background: var(--bg-dark);
  color: #e5e7eb;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
  min-height: 100vh;
}
.card {
  background: var(--card-dark);
  border-radius: 14px;
  padding: 18px;
  box-shadow: 0 8px 28px rgba(15,23,42,.5);
  border: 1px solid #1f2937;
}
.card-kpi {
  border-radius: 14px;
  padding: 18px;
  box-shadow: 0 8px 28px rgba(15,23,42,.6);
  color: #ffffff;
  position: relative;
}
.btn {
  background: var(--accent);
  color: #fff;
  padding: 9px 18px;
  border-radius: 8px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  font-size: .9rem;
}
.btn-ghost {
  background: transparent;
  color: var(--accent);
  padding: 8px 16px;
  border-radius: 8px;
  border: 1px solid var(--accent);
  font-weight: 600;
  cursor: pointer;
  font-size: .85rem;
}
.btn-small{font-size:.75rem;padding:6px 10px;}
.btn-sair {
  background: #020617;
  color: #ffffff;
  padding: 8px 18px;
  border-radius: 10px;
  font-weight: 600;
  border: 1px solid #111827;
  cursor: pointer;
  font-size: .9rem;
}
.hidden{display:none!important;}
.small{font-size:.82rem;}
.required:after{content:"*";color:#f97316;font-weight:700;}
.badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: .7rem;
  font-weight: 600;
}
.badge-green{background:#bbf7d0;color:#14532d;}
.badge-red{background:#fecaca;color:#7f1d1d;}
.badge-blue{background:#bfdbfe;color:#1d4ed8;}
.badge-orange{background:#fed7aa;color:#9a3412;}
.input-base {
  border-radius: 0.5rem;
  border: 1px solid #1f2937;
  padding: 0.5rem 0.75rem;
  font-size: 0.875rem;
  background: #020617;
  color: #e5e7eb;
}
.input-wrapper {
  display: flex;
  align-items: center;
  border-radius: 0.5rem;
  border: 1px solid #1f2937;
  background: #020617;
  padding-right: 0.25rem;
  color: #e5e7eb;
}
.input-wrapper input {
  border: none;
  outline: none;
  background: transparent;
  flex: 1;
  padding: 0.45rem 0.75rem;
  font-size: 0.875rem;
  color: inherit;
}
.input-wrapper button {
  border: none;
  background: transparent;
  cursor: pointer;
  color: #9ca3af;
  font-size: 0.78rem;
  padding: 0 0.25rem;
  white-space: nowrap;
}
.filter-dark {
  background: #020617;
  color: #ffffff;
  border-radius: 0.75rem;
  border: 1px solid #020617;
  padding: 0.5rem 0.75rem;
  font-size: 0.875rem;
}
.filter-dark::placeholder{color:#9ca3af;}
.kpi-tooltip {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  margin-top: 8px;
  background: #020617;
  color: #e5e7eb;
  border-radius: 10px;
  padding: 8px 10px;
  border: 1px solid #1e293b;
  font-size: 0.75rem;
  min-width: 180px;
  max-width: 240px;
  box-shadow: 0 8px 24px rgba(15,23,42,.8);
  z-index: 40;
  opacity: 0;
  pointer-events: none;
  transition: opacity .15s ease-out;
}
.card-kpi.kpi-hover:hover .kpi-tooltip {
  opacity: 1;
}
@media print {
  body{margin:0;background:#e5e7eb;color:#020617;}
  @page{size:A4 landscape;margin:15mm;}
}
</style>
</head>
<body>
<header class="flex items-center justify-between px-6 py-4">
  <div class="flex items-center gap-3">
    <div class="w-11 h-11 rounded-full flex items-center justify-center text-white font-bold" style="background:linear-gradient(135deg,#06b6d4,#2563eb)">NS</div>
    <div>
      <div class="font-semibold text-lg text-slate-100">Nova Saúde</div>
      <div class="text-sm text-slate-300">Controle de Entregas</div>
    </div>
  </div>
  <div class="flex items-center gap-4">
    <div id="userInfo" class="text-xs text-slate-300"></div>
    <div id="clock" class="px-4 py-1 rounded-full bg-slate-900 text-slate-100 text-sm shadow-sm"></div>
  </div>
</header>

<main class="px-4 pb-8">
  <!-- Login -->
  <section id="loginView" class="flex items-center justify-center min-h-[60vh]">
    <div class="card w-full max-w-md">
      <h2 class="text-xl font-bold mb-4 text-slate-50">Acesso ao Sistema</h2>
      <div class="mb-3">
        <label class="small required text-slate-100">Usuário</label>
        <input id="loginUser" class="input-base mt-1 w-full" autocomplete="off">
      </div>
      <div class="mb-3">
        <label class="small required text-slate-100">Senha</label>
        <div class="input-wrapper mt-1">
          <input id="loginPass" type="password" autocomplete="new-password">
          <button type="button" id="toggleLoginPass">Mostrar</button>
        </div>
      </div>
      <div id="loginMsg" class="text-xs text-orange-400 min-h-[1rem] mb-2"></div>
      <div class="flex justify-end gap-2">
        <button id="btnLogin" class="btn">Entrar</button>
        <button id="btnChangePass" class="btn-ghost">Trocar Senha</button>
      </div>
    </div>
  </section>

  <!-- App -->
  <section id="appView" class="hidden">
    <div class="flex flex-wrap items-center justify-between gap-2 mb-4">
      <div class="flex gap-2">
        <button id="btnHome" class="btn-ghost hidden">Início</button>
        <button id="btnHistory" class="btn-ghost">Histórico</button>
        <button id="btnConfig" class="btn-ghost hidden">Configurações</button>
      </div>
      <div class="flex gap-2">
        <button id="btnLogout" class="btn-sair">Sair</button>
      </div>
    </div>

    <div id="dashboard" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4"></div>
    <div id="cardsEntregadores" class="flex flex-wrap gap-3 mb-4"></div>

    <div class="flex flex-col lg:flex-row gap-5">
      <div class="card lg:w-1/3">
        <h3 class="font-semibold mb-3 text-slate-100">Ações Rápidas</h3>
        <button id="btnOpenRegister" class="btn w-full mb-2">Registrar Pedido</button>
        <p class="text-xs text-slate-300">
          Lançar novas entregas do dia.
        </p>
        <button id="btnResetDay" class="btn-ghost mt-4 hidden">Resetar dia</button>
      </div>

      <div class="card flex-1">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-3">
          <select id="filterStatus" class="filter-dark">
            <option value="Todos">Todos</option>
            <option value="separacao">Separação</option>
            <option value="rota">Em rota</option>
            <option value="finalizada">Finalizada Conforme</option>
            <option value="nao-conforme">Não Conforme</option>
          </select>
          <select id="filterSeller" class="filter-dark">
            <option value="Todos">Todos os vendedores</option>
          </select>
          <input id="searchInput" class="filter-dark flex-1" placeholder="Pesquisar nº, cliente ou valor">
          <span class="text-xs text-slate-300">
            Mostrando entregas do dia atual
          </span>
        </div>
        <div id="listaPedidos" class="space-y-2 max-h-[52vh] overflow-auto text-xs"></div>
      </div>
    </div>
  </section>

  <!-- Histórico -->
  <section id="historyView" class="hidden">
    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <h2 class="font-semibold text-lg text-slate-100">
        Histórico de Entregas
      </h2>
      <div class="flex flex-wrap gap-2 items-center text-xs w-full lg:w-auto">
        <select id="historyPeriod" class="border rounded-md px-2 py-1 bg-slate-900 text-slate-100 border-slate-700">
          <option value="currentMs">Mês Atual</option>
          <option value="prevMs">Mês Anterior</option>
          <option value="all">Todo Período</option>
        </select>
        <input id="historyStart" type="date" class="border rounded-md px-2 py-1 bg-slate-900 text-slate-100 border-slate-700">
        <input id="historyEnd" type="date" class="border rounded-md px-2 py-1 bg-slate-900 text-slate-100 border-slate-700">
        <select id="historyStatus" class="border rounded-md px-2 py-1 bg-slate-900 text-slate-100 border-slate-700">
          <option value="Todos">Todos</option>
          <option value="separacao">Separação</option>
          <option value="rota">Em rota</option>
          <option value="finalizada">Finalizada</option>
          <option value="nao-conforme">Não Conforme</option>
        </select>
        <select id="historySeller" class="border rounded-md px-2 py-1 bg-slate-900 text-slate-100 border-slate-700">
          <option value="Todos">Todos os vendedores</option>
        </select>
        <input id="historySearch" class="border rounded-md px-2 py-1 bg-slate-900 text-slate-100 border-slate-700 placeholder-slate-500 flex-1 min-w-[180px]" placeholder="Pesquisar nº, cliente ou valor ...">
        <button id="btnClearFilters" class="btn-ghost">Limpar Filtro</button>
        <button id="btnExport" class="btn">Exportar Excel CSV</button>
        <button id="btnPrint" class="btn-ghost">Imprimir Dashboard</button>
        <button id="btnResetHistory" class="btn-ghost hidden">Resetar Histórico</button>
        <button id="btnBack" class="btn-ghost">Voltar</button>
      </div>
    </div>
    <div id="historyDashboard" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-3"></div>
    <div id="historyEntregadores" class="mb-3"></div>
    <div id="historyList" class="space-y-2 max-h-[62vh] overflow-auto text-xs"></div>
  </section>
</main>

<!-- Modal -->
<div id="modalBg" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div id="modalCont" class="bg-slate-900 rounded-xl p-5 w-full max-w-4xl max-h-[90vh] overflow-auto shadow-xl text-sm text-slate-100">
  </div>
</div>

<!-- Firebase SDK v9+ -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
import { getDatabase, ref, set, push, get, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyB5kSSNVyfIyGq9cOe1n8EmMtVhXW7gryY",
  authDomain: "nova-saude-sistema-entregas.firebaseapp.com",
  databaseURL: "https://nova-saude-sistema-entregas-default-rtdb.firebaseio.com",
  projectId: "nova-saude-sistema-entregas",
  storageBucket: "nova-saude-sistema-entregas.firebasestorage.app",
  messagingSenderId: "817212957836",
  appId: "1:817212957836:web:920d639f86757b0fde87a9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Exportar para uso global
window.db = db;
window.ref = ref;
window.set = set;
window.push = push;
window.get = get;
window.remove = remove;
window.onValue = onValue;
</script>

<script type="module">
let currentUser = null;
let lastDashboardDay = new Date().toISOString().slice(0,10);
let modalStackContent = null;

// ===== CLOCK =====
function updateClock(){
  const d=new Date();
  const f=n=>String(n).padStart(2,'0');
  const el=document.getElementById('clock');
  if(el) el.textContent=`${f(d.getHours())}:${f(d.getMinutes())}:${f(d.getSeconds())}`;
}
window.updateClock = updateClock;
updateClock();
setInterval(updateClock,1000);

setInterval(()=>{
  const hoje=new Date().toISOString().slice(0,10);
  if(hoje!==lastDashboardDay && currentUser){
    lastDashboardDay=hoje;
    atualizaDashboard();
    atualizaCardsEntregadores();
    atualizaListaPedidos();
  }
},60000);

// ===== FIREBASE HELPERS =====
async function fbGet(path) {
  const snapshot = await window.get(window.ref(window.db, path));
  return snapshot.exists() ? snapshot.val() : null;
}

async function fbSet(path, data) {
  await window.set(window.ref(window.db, path), data);
}

async function fbPush(path, data) {
  const newRef = window.push(window.ref(window.db, path));
  await window.set(newRef, data);
  return newRef.key;
}

async function fbRemove(path) {
  await window.remove(window.ref(window.db, path));
}

// ===== INICIALIZAÇÃO =====
async function ensureInit(){
  const users = await fbGet('users');
  if(!users){
    await fbSet('users/admin', {usuario:'admin',senha:'admin',nome:'Administrador',perfil:'admin'});
    await fbSet('users/operador', {usuario:'operador',senha:'operador',nome:'Operador',perfil:'operador'});
    await fbSet('users/observador', {usuario:'obs',senha:'observador',nome:'Observador',perfil:'observador'});
  }
  
  const vends = await fbGet('vendedores');
  if(!vends){
    await fbSet('vendedores/v1', {nome:'Fulano'});
    await fbSet('vendedores/v2', {nome:'Beltrano'});
  }
  
  const ents = await fbGet('entregadores');
  if(!ents){
    await fbSet('entregadores/e1', {nome:'João'});
    await fbSet('entregadores/e2', {nome:'Pedro'});
  }
  
  const pags = await fbGet('pagamentos');
  if(!pags){
    await fbSet('pagamentos/p1', {nome:'Pix'});
    await fbSet('pagamentos/p2', {nome:'Cartão'});
    await fbSet('pagamentos/p3', {nome:'Dinheiro'});
    await fbSet('pagamentos/p4', {nome:'Transferência'});
  }
}
window.ensureInit = ensureInit;

// ===== MODAL =====
function abreModal(titulo, html){
  const bg = document.getElementById('modalBg');
  const cont = document.getElementById('modalCont');
  cont.innerHTML = `<div class="flex justify-between items-center mb-4">
    <div class="font-semibold">${titulo}</div>
    <button id="btnFecharModal" class="text-xs text-slate-400">Fechar ✕</button>
  </div>${html}`;
  bg.classList.remove('hidden');
  const btnFechar = document.getElementById('btnFecharModal');
  if(btnFechar) btnFechar.addEventListener('click', ()=>fechaModal(true));
}
window.abreModal = abreModal;

function fechaModal(resetStack=false){
  document.getElementById('modalBg').classList.add('hidden');
  document.getElementById('modalCont').innerHTML = '';
  if(resetStack) modalStackContent=null;
}
window.fechaModal = fechaModal;

function alertaModal(msg, onClose){
  const bg = document.getElementById('modalBg');
  const cont = document.getElementById('modalCont');
  if(!modalStackContent) modalStackContent = cont.innerHTML;
  cont.innerHTML = `<div class="flex justify-between items-center mb-4">
    <div class="font-semibold">Aviso</div>
    <button id="btnFecharAlertaX" class="text-xs text-slate-400">Fechar ✕</button>
  </div>
  <p class="mb-4 text-orange-300">${msg}</p>
  <button id="btnFecharAlerta" class="btn w-full">Fechar</button>`;
  bg.classList.remove('hidden');
  const fechar = ()=>{
    restaurarModalStack();
    if(onClose) onClose();
  };
  const btnX = document.getElementById('btnFecharAlertaX');
  const btnFechar = document.getElementById('btnFecharAlerta');
  if(btnX) btnX.addEventListener('click', fechar);
  if(btnFechar) btnFechar.addEventListener('click', fechar);
}
window.alertaModal = alertaModal;

function restaurarModalStack(){
  if(!modalStackContent){fechaModal(true);return;}
  const cont=document.getElementById('modalCont');
  cont.innerHTML=modalStackContent;
  modalStackContent=null;
}
window.restaurarModalStack = restaurarModalStack;

// ===== UTILS =====
function aplicarMascaraMoeda(el){
  let v=el.value.replace(/[^0-9]/g,'');
  if(!v) v='0';
  v=String(parseInt(v,10));
  while(v.length<3) v='0'+v;
  const int=v.slice(0,-2);
  const dec=v.slice(-2);
  const intFmt=int.replace(/\B(?=(\d{3})+(?!\d))/g,'.');
  el.value=`${intFmt},${dec}`;
}
window.aplicarMascaraMoeda = aplicarMascaraMoeda;

function parseMoedaToNumber(str){
  if(!str) return 0;
  const limpo=str.replace(/\./g,'').replace(',','.');
  const n=parseFloat(limpo);
  return isNaN(n)?0:n;
}
window.parseMoedaToNumber = parseMoedaToNumber;

function capitalizarPrimeira(str){
  const t=str.trim();
  if(!t)return '';
  return t.charAt(0).toUpperCase()+t.slice(1);
}
window.capitalizarPrimeira = capitalizarPrimeira;

// ===== VENDEDORES =====
async function carregaVendedoresSelects(){
  const vends = await fbGet('vendedores');
  const selFiltro=document.getElementById('filterSeller');
  const selHist=document.getElementById('historySeller');
  const opts='<option value="Todos">Todos os vendedores</option>'+
    (vends?Object.values(vends).map(v=>`<option value="${v.nome}">${v.nome}</option>`).join(''):'');
  if(selFiltro) selFiltro.innerHTML=opts;
  if(selHist) selHist.innerHTML=opts;
}
window.carregaVendedoresSelects = carregaVendedoresSelects;

// ===== DASHBOARD =====
async function atualizaDashboard(){
  const pedidos = await fbGet('pedidos');
  const hoje=new Date().toISOString().slice(0,10);
  const dia=(pedidos?Object.values(pedidos):[]).filter(p=>p.dataEntrada?.startsWith(hoje));
  const sep=dia.filter(p=>p.status==='separacao').length;
  const rota=dia.filter(p=>p.status==='rota').length;
  const finC=dia.filter(p=>p.status==='finalizada'&&p.conforme).length;
  const nc=dia.filter(p=>p.teveNC).length;
  const total=dia.length;

  const mapPorEntregador={};
  dia.forEach(p=>{
    const ent=p.entregador||'Sem entregador';
    if(!mapPorEntregador[ent]) mapPorEntregador[ent]={rota:0,fin:0,nc:0,total:0};
    mapPorEntregador[ent].total++;
    if(p.status==='rota')mapPorEntregador[ent].rota++;
    if(p.status==='finalizada'&&p.conforme)mapPorEntregador[ent].fin++;
    if(p.teveNC)mapPorEntregador[ent].nc++;
  });

  function renderTooltip(tipo){
    const linhas=Object.entries(mapPorEntregador)
      .filter(([,v])=>{
        if(tipo==='rota')return v.rota>0;
        if(tipo==='fin')return v.fin>0;
        if(tipo==='nc')return v.nc>0;
        if(tipo==='total')return v.total>0;
        return false;
      })
      .map(([nome,v])=>{
        if(tipo==='rota')return `${nome}: ${v.rota}`;
        if(tipo==='fin')return `${nome}: ${v.fin}`;
        if(tipo==='nc')return `${nome}: ${v.nc}`;
        if(tipo==='total')return `${nome}: ${v.total}`;
      });
    if(!linhas.length)return '';
    return `<div class="kpi-tooltip">${linhas.map(l=>`<div>${l}</div>`).join('')}</div>`;
  }
  window.renderTooltip = renderTooltip;

  document.getElementById('dashboard').innerHTML=`
    <div class="card-kpi bg-blue-600">
      <div class="text-xs uppercase">SEPARAÇÃO</div>
      <div class="text-2xl font-bold mt-1">${sep}</div>
    </div>
    <div class="card-kpi bg-orange-500 kpi-hover">
      <div class="text-xs uppercase">EM ROTA</div>
      <div class="text-2xl font-bold mt-1">${rota}</div>
      ${renderTooltip('rota')}
    </div>
    <div class="card-kpi bg-emerald-600 kpi-hover">
      <div class="text-xs uppercase">FINALIZADAS C</div>
      <div class="text-2xl font-bold mt-1">${finC}</div>
      ${renderTooltip('fin')}
    </div>
    <div class="card-kpi bg-red-600 kpi-hover">
      <div class="text-xs uppercase">NÃO CONFORMES</div>
      <div class="text-2xl font-bold mt-1">${nc}</div>
      ${renderTooltip('nc')}
    </div>
    <div class="card-kpi bg-slate-900 kpi-hover">
      <div class="text-xs uppercase">TOTAL HOJE</div>
      <div class="text-2xl font-bold mt-1">${total}</div>
      ${renderTooltip('total')}
    </div>`;
}

async function atualizaCardsEntregadores(){
  const ents = await fbGet('entregadores');
  const pedidos = await fbGet('pedidos');
  const hoje=new Date().toISOString().slice(0,10);
  let html='';
  if(ents){
    Object.values(ents).forEach(e=>{
      const lista=(pedidos?Object.values(pedidos):[]).filter(p=>p.dataEntrada?.startsWith(hoje)&&p.entregador===e.nome);
      const rota=lista.filter(p=>p.status==='rota').length;
      const fin=lista.filter(p=>p.status==='finalizada'&&p.conforme).length;
      const nc=lista.filter(p=>p.teveNC).length;
      html+=`<div class="card min-w-[150px] text-xs">
        <div class="font-semibold mb-1 text-slate-100">${e.nome}</div>
        <div class="text-slate-200">Em rota: ${rota}</div>
        <div class="text-slate-200">Finalizadas: ${fin}</div>
        <div class="text-slate-200">Não conformes: ${nc}</div>
        <div class="mt-1 text-slate-200">Total: ${lista.length}</div>
      </div>`;
    });
  }
  document.getElementById('cardsEntregadores').innerHTML=html||'<p class="text-xs text-slate-300">Nenhum entregador cadastrado.</p>';
}
window.atualizaCardsEntregadores = atualizaCardsEntregadores;

function linhaEntregadorSaida(p){
  if(!p.saida||!p.entregador) return '';
  const hSaida=new Date(p.saida).toLocaleTimeString('pt-BR');
  return `<div class="text-slate-400 text-[11px] mt-0.5">
    Entregador: ${p.entregador} - Saída para rota de entrega: ${hSaida}
  </div>`;
}
window.linhaEntregadorSaida = linhaEntregadorSaida;

async function atualizaListaPedidos(){
  const pedidos = await fbGet('pedidos');
  const hoje=new Date().toISOString().slice(0,10);
  let lista=(pedidos?Object.values(pedidos):[]).filter(p=>p.dataEntrada?.startsWith(hoje));
  
  const filtro=document.getElementById('filterStatus').value;
  const filtroVend=document.getElementById('filterSeller').value;
  const busca=document.getElementById('searchInput').value.trim().toLowerCase();
  
  if(filtro!=='Todos'){
    if(filtro==='finalizada') lista=lista.filter(p=>p.status==='finalizada'&&p.conforme);
    else lista=lista.filter(p=>p.status===filtro);
  }
  if(filtroVend!=='Todos') lista=lista.filter(p=>p.vendedor===filtroVend);
  if(busca) lista=lista.filter(p=>p.numero.toLowerCase().includes(busca)||p.cliente.toLowerCase().includes(busca)||String(p.valor).includes(busca));
  
  window.atualizaListaPedidos = atualizaListaPedidos;
  
  const corStatus=(p)=>{
    if(p.status==='separacao')return'badge badge-blue';
    if(p.status==='rota')return'badge badge-orange';
    if(p.status==='finalizada'&&p.conforme)return'badge badge-green';
    if(p.status==='nao-conforme')return'badge badge-red';
    if(p.status==='finalizada'&&p.conforme&&p.teveNC)return'badge badge-red';
    return'badge';
  };
  const txtStatus=(p)=>{
    if(p.status==='separacao')return'Separação';
    if(p.status==='rota')return'Em rota';
    if(p.status==='nao-conforme')return'Não conforme';
    if(p.status==='finalizada'&&p.conforme&&p.teveNC)return'<span class="text-red-400 font-bold">NC</span> <span>finalizada</span>';
    if(p.status==='finalizada'&&p.conforme)return'Finalizada C';
    return p.status;
  };
  
  let html='';
  lista.sort((a,b)=>a.numero.localeCompare(b.numero));
  lista.forEach(p=>{
    const podeEditar=currentUser&&currentUser.perfil!=='observador';
    const linhaClasse=p.status==='nao-conforme'?'bg-red-900/30':'bg-slate-900';
    const obsTxt=p.observacoes?` | Obs: ${p.observacoes}`:'';
    html+=`<div class="border border-slate-700 rounded-md px-3 py-2 flex justify-between items-center ${linhaClasse}">
      <div class="text-left flex-1 text-xs item-detalhe" data-id="${p.id}">
        <div class="font-semibold text-slate-100">${p.numero} - ${p.cliente}</div>
        <div class="text-slate-300">${p.vendedor} | ${new Date(p.dataEntrada).toLocaleString('pt-BR')} | R$ ${p.valor.toFixed(2)} | ${p.pagamento}${obsTxt}</div>
        ${linhaEntregadorSaida(p)}
        <div class="mt-1"><span class="${corStatus(p)}">${p.status==='finalizada'&&p.conforme&&p.teveNC?'<span class="text-red-700 font-bold">NC</span> <span>finalizada</span>':txtStatus(p)}</span></div>
      </div>
      <div class="flex flex-col gap-1 ml-2">
        <button class="btn-small btn-ghost btn-acoes" data-id="${p.id}" ${podeEditar?'':'disabled'}>Ações</button>
        <button class="btn-small btn-ghost text-red-400 border-red-500 btn-excluir" data-id="${p.id}" ${podeEditar?'':'disabled'}>Excluir</button>
      </div>
    </div>`;
  });
  
  const listaEl=document.getElementById('listaPedidos');
  listaEl.innerHTML=html||'<p class="text-xs text-slate-300">Nenhuma entrega para hoje.</p>';
  
  listaEl.querySelectorAll('.item-detalhe').forEach(el=>{
    el.addEventListener('click',()=>abrirDetalhesEntrega(el.dataset.id));
  });
  listaEl.querySelectorAll('.btn-acoes').forEach(btn=>{
    btn.addEventListener('click',ev=>{ev.stopPropagation();abrirAcoesEntrega(btn.dataset.id);});
  });
  listaEl.querySelectorAll('.btn-excluir').forEach(btn=>{
    btn.addEventListener('click',ev=>{ev.stopPropagation();excluirPedido(btn.dataset.id);});
  });
}

async function excluirPedido(id){
  if(!currentUser||currentUser.perfil==='observador')return;
  if(!confirm('Confirma excluir esta entrega?'))return;
  await fbRemove(`pedidos/${id}`);
  atualizaDashboard();atualizaCardsEntregadores();atualizaListaPedidos();atualizaHistorico();
}
window.excluirPedido = excluirPedido;

// ===== HISTÓRICO =====
async function atualizaHistorico(){
  const pedidos = await fbGet('pedidos');
  const periodo=document.getElementById('historyPeriod').value;
  const dIni=document.getElementById('historyStart').value;
  const dFim=document.getElementById('historyEnd').value;
  const statusF=document.getElementById('historyStatus').value;
  const vendF=document.getElementById('historySeller').value;
  const busca=document.getElementById('historySearch').value.trim().toLowerCase();
  
  window.atualizaHistorico = atualizaHistorico;
  
  let lista=pedidos?Object.values(pedidos):[];
  let di=null,df=null;
  if(dIni) di=new Date(dIni+'T00:00:00');
  if(dFim) df=new Date(dFim+'T23:59:59');
  
  lista=lista.filter(p=>{
    const dt=new Date(p.dataEntrada);
    if(periodo==='currentMs'){
      const n=new Date();
      if(dt.getMonth()!==n.getMonth()||dt.getFullYear()!==n.getFullYear())return false;
    }else if(periodo==='prevMs'){
      const n=new Date();
      let m=n.getMonth()-1,y=n.getFullYear();
      if(m<0){m=11;y--;}
      if(dt.getMonth()!==m||dt.getFullYear()!==y)return false;
    }
    if(di&&dt<di)return false;
    if(df&&dt>df)return false;
    if(statusF!=='Todos'){
      if(statusF==='nao-conforme'){if(!p.teveNC)return false;}
      else if(statusF==='finalizada'){if(p.status!=='finalizada')return false;}
      else {if(p.status!==statusF)return false;}
    }
    if(vendF!=='Todos'&&p.vendedor!==vendF)return false;
    if(busca){
      if(!(p.numero.toLowerCase().includes(busca)||p.cliente.toLowerCase().includes(busca)||String(p.valor).includes(busca)))return false;
    }
    return true;
  });
  
  const total=lista.length;
  const fin=lista.filter(p=>p.status==='finalizada'&&p.conforme).length;
  const rota=lista.filter(p=>p.status==='rota').length;
  const nc=lista.filter(p=>p.teveNC).length;
  
  document.getElementById('historyDashboard').innerHTML=`
    <div class="card-kpi bg-orange-500">
      <div class="text-xs uppercase">EM ROTA</div>
      <div class="text-2xl font-bold mt-1">${rota}</div>
    </div>
    <div class="card-kpi bg-emerald-600">
      <div class="text-xs uppercase">FINALIZADAS C</div>
      <div class="text-2xl font-bold mt-1">${fin}</div>
    </div>
    <div class="card-kpi bg-red-600">
      <div class="text-xs uppercase">NÃO CONFORMES</div>
      <div class="text-2xl font-bold mt-1">${nc}</div>
    </div>
    <div class="card-kpi bg-slate-900">
      <div class="text-xs uppercase">TOTAL</div>
      <div class="text-2xl font-bold mt-1">${total}</div>
    </div>`;
  
  const ents = await fbGet('entregadores');
  let htmlEnt='<h3 class="font-semibold mb-2 text-slate-100">Entregas por Entregador (filtro atual)</h3>';
  if(ents){
    htmlEnt+='<div class="flex flex-wrap gap-3 text-xs">';
    Object.values(ents).forEach(e=>{
      const l=lista.filter(p=>p.entregador===e.nome);
      if(l.length===0)return;
      const rotaE=l.filter(p=>p.status==='rota').length;
      const finE=l.filter(p=>p.status==='finalizada'&&p.conforme).length;
      const ncE=l.filter(p=>p.teveNC).length;
      htmlEnt+=`<div class="card min-w-[150px]">
        <div class="font-semibold mb-1 text-slate-100">${e.nome}</div>
        <div class="text-slate-200">Em rota: ${rotaE}</div>
        <div class="text-slate-200">Finalizadas: ${finE}</div>
        <div class="text-slate-200">Não conformes: ${ncE}</div>
        <div class="mt-1 text-slate-200">Total: ${l.length}</div>
      </div>`;
    });
    htmlEnt+='</div>';
  }else{
    htmlEnt+='<p class="text-xs text-slate-300">Nenhum entregador cadastrado.</p>';
  }
  document.getElementById('historyEntregadores').innerHTML=htmlEnt;
  
  let html='';
  lista.sort((a,b)=>new Date(b.dataEntrada)-new Date(a.dataEntrada));
  lista.forEach(p=>{
    const podeEditar=currentUser&&currentUser.perfil!=='observador';
    const linhaClasse=p.status==='nao-conforme'?'bg-red-900/30':'bg-slate-900';
    const eStatus=p.status==='nao-conforme'?'Não conforme':(p.status==='finalizada'&&p.conforme&&p.teveNC?'<span class="text-red-400 font-bold">NC</span> <span>finalizada</span>':(p.status==='finalizada'&&p.conforme?'Finalizada C':(p.status==='rota'?'Em rota':(p.status==='separacao'?'Separação':p.status))));
    const obsTxt=p.observacoes?` | Obs: ${p.observacoes}`:'';
    html+=`<div class="border border-slate-700 rounded-md px-3 py-2 flex justify-between items-center ${linhaClasse}">
      <div class="text-left flex-1 item-detalhe" data-id="${p.id}">
        <div class="font-semibold text-slate-100">${p.numero} - ${p.cliente}</div>
        <span class="text-slate-400">${p.vendedor}</span> | 
        <span class="text-slate-400">${new Date(p.dataEntrada).toLocaleString('pt-BR')}</span> | 
        <span class="text-slate-400">R$ ${p.valor.toFixed(2)}</span> | 
        <span class="text-slate-400">${p.pagamento}</span>${obsTxt} | 
        <span>${eStatus}</span>
      </div>
    </div>`;
  });
  
  const histEl = document.getElementById('historyList');
  histEl.innerHTML=html||'<p class="text-xs text-slate-300">Nenhum registro encontrado.</p>';
  histEl.querySelectorAll('.item-detalhe').forEach(el=>{
    el.addEventListener('click',()=>abrirDetalhesEntrega(el.dataset.id));
  });
}

function limparFiltrosHistorico(){
  document.getElementById('historyPeriod').value='currentMs';
  document.getElementById('historyStart').value='';
  document.getElementById('historyEnd').value='';
  document.getElementById('historyStatus').value='Todos';
  document.getElementById('historySeller').value='Todos';
  document.getElementById('historySearch').value='';
  atualizaHistorico();
}
window.limparFiltrosHistorico = limparFiltrosHistorico;

// ===== DETALHES/AÇÕES =====
async function abrirDetalhesEntrega(id){
  const pedidos = await fbGet('pedidos');
  if(!pedidos||!pedidos[id]){alertaModal('Entrega não encontrada.');return;}
  const p = pedidos[id];
  
  let andHtml='';
  if(p.andamentos&&p.andamentos.length){
    andHtml='<ul class="list-disc pl-5 mt-1">';
    p.andamentos.forEach(a=>{
      andHtml+=`<li class="mb-1"><span class="text-slate-400">${new Date(a.data).toLocaleString('pt-BR')} (${a.usuario})</span>: ${a.descricao}</li>`;
    });
    andHtml+='</ul>';
  }else{
    andHtml='<div class="text-xs text-slate-400">Sem andamentos</div>';
  }
  
  window.abrirDetalhesEntrega = abrirDetalhesEntrega;
  
  const html=`<div class="text-xs space-y-1">
    <div><b>Número:</b> ${p.numero}</div>
    <div><b>Cliente:</b> ${p.cliente}</div>
    <div><b>Vendedor:</b> ${p.vendedor}</div>
    <div><b>Valor:</b> R$ ${p.valor.toFixed(2)}</div>
    <div><b>Pagamento:</b> ${p.pagamento||'-'}</div>
    <div><b>Observações:</b> ${p.observacoes||'-'}</div>
    <div><b>Entrada:</b> ${p.dataEntrada?new Date(p.dataEntrada).toLocaleString('pt-BR'):'-'}</div>
    <div><b>Saída:</b> ${p.saida?new Date(p.saida).toLocaleString('pt-BR'):'-'}</div>
    <div><b>Entregador:</b> ${p.entregador||'-'}</div>
    <div><b>Status:</b> ${p.status}</div>
    <div><b>Justificativa:</b> ${p.justificativa||'-'}</div>
    <div class="mt-3 font-semibold">Andamentos</div>
    ${andHtml}
  </div>`;
  abreModal('Detalhes da Entrega',html);
}

async function abrirAcoesEntrega(id){
  const pedidos = await fbGet('pedidos');
  if(!pedidos||!pedidos[id]){alertaModal('Entrega não encontrada.');return;}
  const p = pedidos[id];
  
  const soLeitura=!currentUser||currentUser.perfil==='observador';
  const ents = await fbGet('entregadores');
  const selEnt=(ents?Object.values(ents):[]).map(e=>`<option value="${e.nome}" ${e.nome===p.entregador?'selected':''}>${e.nome}</option>`).join('');
  
  let saidaInfo='';
  if(p.saida){
    saidaInfo=`<div class="text-xs text-slate-400">Saída registrada: ${new Date(p.saida).toLocaleString('pt-BR')} (${p.entregador||'-'})</div>`;
  }
  
  window.abrirAcoesEntrega = abrirAcoesEntrega;
  
  let botoesSaida='';
  let blocoResultado='';
  
  if(!soLeitura){
    if(p.status==='separacao'){
      botoesSaida=`<div class="mt-3">
        <label class="small block mb-1">Entregador</label>
        <select id="acaoEntregador" class="border border-slate-700 rounded-md px-2 py-1 text-xs w-full bg-slate-900 text-slate-100">
          <option value="">Selecione...</option>
          ${selEnt}
        </select>
      </div>
      <button class="btn mt-3 btn-confirmar-saida" data-id="${p.id}">Confirmar Saída</button>`;
    }else if(p.saida){
      botoesSaida=`${saidaInfo}
      <div class="mt-3 flex gap-2">
        <button class="btn-ghost btn-desfazer-saida" data-id="${p.id}">Desfazer Saída</button>
      </div>`;
    }
    
    if(p.status==='rota'){
      blocoResultado=`<div class="mt-4 space-y-2">
        <div class="small font-semibold">Finalizar Entrega</div>
        <div class="flex gap-2">
          <button class="btn bg-emerald-600 btn-finalizar-conforme" data-id="${p.id}">Conforme</button>
          <button class="btn bg-red-600 btn-abrir-nc" data-id="${p.id}">Não Conforme</button>
        </div>
      </div>`;
    }else if(p.status==='nao-conforme'){
      blocoResultado=`<div class="mt-4 space-y-2">
        <div class="small font-semibold">Entrega Não Conforme</div>
        <button class="btn-ghost btn-registrar-andamento" data-id="${p.id}">Registrar andamento</button>
      </div>`;
    }else if(p.status==='finalizada'){
      blocoResultado=`<div class="mt-4 space-y-2">
        <div class="small font-semibold">Entrega Finalizada</div>
        <button class="btn-ghost btn-desfazer-finalizacao" data-id="${p.id}">Desfazer Finalização</button>
      </div>`;
    }
  }
  
  const html=`<div class="text-xs space-y-2">
    <div><b>Número:</b> ${p.numero}</div>
    <div><b>Cliente:</b> ${p.cliente}</div>
    <div><b>Status:</b> ${p.status}</div>
    ${saidaInfo}
    ${botoesSaida}
    ${blocoResultado}
  </div>`;
  
  abreModal('Ações da Entrega',html);
  
  document.querySelectorAll('.btn-confirmar-saida').forEach(btn=>{
    btn.addEventListener('click',()=>confirmarSaida(btn.dataset.id));
  });
  document.querySelectorAll('.btn-desfazer-saida').forEach(btn=>{
    btn.addEventListener('click',()=>desfazerSaida(btn.dataset.id));
  });
  document.querySelectorAll('.btn-finalizar-conforme').forEach(btn=>{
    btn.addEventListener('click',()=>finalizarEntregaConforme(btn.dataset.id));
  });
  document.querySelectorAll('.btn-abrir-nc').forEach(btn=>{
    btn.addEventListener('click',()=>abrirNaoConforme(btn.dataset.id));
  });
  document.querySelectorAll('.btn-registrar-andamento').forEach(btn=>{
    btn.addEventListener('click',()=>abrirRegistrarAndamento(btn.dataset.id));
  });
  document.querySelectorAll('.btn-desfazer-finalizacao').forEach(btn=>{
    btn.addEventListener('click',()=>desfazerFinalizacao(btn.dataset.id));
  });
}

async function confirmarSaida(id){
  const pedidos = await fbGet('pedidos');
  if(!pedidos||!pedidos[id])return;
  const p=pedidos[id];
  const sel=document.getElementById('acaoEntregador');
  if(!sel){alertaModal('Selecione o entregador.');return;}
  const entregador=sel.value.trim();
  if(!entregador){alertaModal('Selecione o entregador.');return;}
  p.entregador=entregador;
  p.saida=new Date().toISOString();
  p.status='rota';
  await fbSet(`pedidos/${id}`,p);
  window.confirmarSaida = confirmarSaida;
  fechaModal(true);
  atualizaDashboard();atualizaCardsEntregadores();atualizaListaPedidos();atualizaHistorico();
}

async function desfazerSaida(id){
  const pedidos = await fbGet('pedidos');
  if(!pedidos||!pedidos[id])return;
  const p=pedidos[id];
  p.saida=null;p.entregador=null;p.status='separacao';
  await fbSet(`pedidos/${id}`,p);
  window.desfazerSaida = desfazerSaida;
  fechaModal(true);
  atualizaDashboard();atualizaCardsEntregadores();atualizaListaPedidos();atualizaHistorico();
}

async function finalizarEntregaConforme(id){
  const pedidos = await fbGet('pedidos');
  if(!pedidos||!pedidos[id])return;
  const p=pedidos[id];
  p.status='finalizada';
  p.conforme=true;
  await fbSet(`pedidos/${id}`,p);
  window.finalizarEntregaConforme = finalizarEntregaConforme;
  fechaModal(true);
  atualizaDashboard();atualizaCardsEntregadores();atualizaListaPedidos();atualizaHistorico();
}

async function abrirNaoConforme(id){
  const html=`<div class="space-y-3 text-xs">
    <div class="small font-semibold">Justificativa do Não Conforme</div>
    <textarea id="ncJust" class="border border-slate-700 rounded-md w-full px-2 py-1 h-24 bg-slate-900 text-slate-100"></textarea>
    <div class="flex gap-2 justify-end">
      <button class="btn-ghost btn-nc-cancelar">Cancelar</button>
      <button class="btn bg-red-600 btn-nc-salvar" data-id="${id}">Salvar Não Conforme</button>
    </div>
  </div>`;
  abreModal('Registrar Não Conforme',html);
  document.querySelectorAll('.btn-nc-cancelar').forEach(btn=>btn.addEventListener('click',()=>fechaModal(true)));
  document.querySelectorAll('.btn-nc-salvar').forEach(btn=>btn.addEventListener('click',()=>salvarNaoConformeInicial(btn.dataset.id)));
}
window.abrirNaoConforme = abrirNaoConforme;

async function salvarNaoConformeInicial(id){
  let txt=document.getElementById('ncJust').value;
  txt=capitalizarPrimeira(txt);
  if(!txt){alertaModal('Informe a justificativa.');return;}
  const pedidos = await fbGet('pedidos');
  if(!pedidos||!pedidos[id])return;
  const p=pedidos[id];
  p.status='nao-conforme';
  p.conforme=false;
  p.justificativa=txt;
  p.andamentos=p.andamentos||[];
  p.andamentos.push({data:new Date().toISOString(),usuario:currentUser.nome,descricao:txt});
  p.teveNC=true;
  await fbSet(`pedidos/${id}`,p);
  window.salvarNaoConformeInicial = salvarNaoConformeInicial;
  fechaModal(true);
  atualizaDashboard();atualizaCardsEntregadores();atualizaListaPedidos();atualizaHistorico();
}

async function abrirRegistrarAndamento(id){
  const html=`<div class="space-y-3 text-xs">
    <div class="small font-semibold">Registrar andamento</div>
    <textarea id="ncAnd" class="border border-slate-700 rounded-md w-full px-2 py-1 h-24 bg-slate-900 text-slate-100"></textarea>
    <div class="flex gap-2 justify-between flex-wrap">
      <button class="btn bg-red-600 flex-1 btn-andamento-manter" data-id="${id}">Manter Não Conforme</button>
      <button class="btn bg-emerald-600 flex-1 btn-andamento-finalizar" data-id="${id}">Finalizar</button>
    </div>
  </div>`;
  abreModal('Registrar Andamento - Não Conforme',html);
  document.querySelectorAll('.btn-andamento-manter').forEach(btn=>btn.addEventListener('click',()=>salvarAndamentoNc(btn.dataset.id,'manter')));
  document.querySelectorAll('.btn-andamento-finalizar').forEach(btn=>btn.addEventListener('click',()=>salvarAndamentoNc(btn.dataset.id,'finalizar')));
}
window.abrirRegistrarAndamento = abrirRegistrarAndamento;

async function salvarAndamentoNc(id,acao){
  let txt=document.getElementById('ncAnd').value;
  txt=capitalizarPrimeira(txt);
  if(!txt){alertaModal('Informe a justificativa/andamento.');return;}
  const pedidos = await fbGet('pedidos');
  if(!pedidos||!pedidos[id])return;
  const p=pedidos[id];
  p.andamentos=p.andamentos||[];
  p.andamentos.push({data:new Date().toISOString(),usuario:currentUser.nome,descricao:txt});
  p.teveNC=true;
  if(acao==='finalizar'){
    p.status='finalizada';
    p.conforme=true;
  }
  await fbSet(`pedidos/${id}`,p);
  window.salvarAndamentoNc = salvarAndamentoNc;
  fechaModal(true);
  atualizaDashboard();atualizaCardsEntregadores();atualizaListaPedidos();atualizaHistorico();
}

async function desfazerFinalizacao(id){
  const pedidos = await fbGet('pedidos');
  if(!pedidos||!pedidos[id])return;
  const p=pedidos[id];
  p.status=p.saida?'rota':'separacao';
  p.conforme=null;
  await fbSet(`pedidos/${id}`,p);
  window.desfazerFinalizacao = desfazerFinalizacao;
  fechaModal(true);
  atualizaDashboard();atualizaCardsEntregadores();atualizaListaPedidos();atualizaHistorico();
}

// ===== TROCAR SENHA =====
function abreModalTrocarSenhaLogin(usuarioDigitado){
  const html=`<div class="text-xs space-y-3">
    <div>Usuário: <b>${usuarioDigitado||'não informado'}</b></div>
    <div>
      <label class="small required block mb-1">Senha atual</label>
      <input id="senhaAtual" type="password" class="border border-slate-700 w-full rounded-md px-2 py-1 bg-slate-900 text-slate-100">
    </div>
    <div>
      <label class="small required block mb-1">Nova senha</label>
      <input id="novaSenha1" type="password" class="border border-slate-700 w-full rounded-md px-2 py-1 bg-slate-900 text-slate-100">
    </div>
    <div>
      <label class="small required block mb-1">Confirmar nova senha</label>
      <input id="novaSenha2" type="password" class="border border-slate-700 w-full rounded-md px-2 py-1 bg-slate-900 text-slate-100">
    </div>
    <div class="flex justify-end gap-2 mt-2">
      <button class="btn-ghost btn-troca-cancelar">Cancelar</button>
      <button class="btn btn-troca-salvar" data-usuario="${usuarioDigitado}">Salvar</button>
    </div>
  </div>`;
  abreModal('Trocar Senha',html);
  document.querySelectorAll('.btn-troca-cancelar').forEach(btn=>btn.addEventListener('click',()=>fechaModal(true)));
  document.querySelectorAll('.btn-troca-salvar').forEach(btn=>btn.addEventListener('click',()=>executarTrocaSenhaLogin(btn.dataset.usuario)));
}
window.abreModalTrocarSenhaLogin = abreModalTrocarSenhaLogin;

async function executarTrocaSenhaLogin(usuarioDigitado){
  const usuario=usuarioDigitado.trim().toLowerCase();
  if(!usuario){alertaModal('Informe o usuário na tela de login antes de trocar a senha.');return;}
  const users = await fbGet('users');
  if(!users||!users[usuario]){alertaModal('Usuário não encontrado.');return;}
  const user=users[usuario];
  const atual=document.getElementById('senhaAtual').value.trim();
  const nova1=document.getElementById('novaSenha1').value.trim();
  const nova2=document.getElementById('novaSenha2').value.trim();
  if(!atual||!nova1||!nova2){alertaModal('Preencha todos os campos de senha.');return;}
  if(user.senha!==atual){alertaModal('Senha atual incorreta.');return;}
  if(nova1!==nova2){alertaModal('Nova senha e confirmação não conferem.');return;}
  user.senha=nova1;
  await fbSet(`users/${usuario}`,user);
  fechaModal(true);
  alertaModal('Senha alterada com sucesso.');
}
window.executarTrocaSenhaLogin = executarTrocaSenhaLogin;

function abreModalTrocarSenhaInterno(){
  if(!currentUser)return;
  const html=`<div class="text-xs space-y-3">
    <div>Usuário: <b>${currentUser.usuario} (${currentUser.nome})</b></div>
    <div>
      <label class="small required block mb-1">Senha atual</label>
      <input id="senhaAtualInt" type="password" class="border border-slate-700 w-full rounded-md px-2 py-1 bg-slate-900 text-slate-100">
    </div>
    <div>
      <label class="small required block mb-1">Nova senha</label>
      <input id="novaSenha1Int" type="password" class="border border-slate-700 w-full rounded-md px-2 py-1 bg-slate-900 text-slate-100">
    </div>
    <div>
      <label class="small required block mb-1">Confirmar nova senha</label>
      <input id="novaSenha2Int" type="password" class="border border-slate-700 w-full rounded-md px-2 py-1 bg-slate-900 text-slate-100">
    </div>
    <div class="flex justify-end gap-2 mt-2">
      <button class="btn-ghost btn-troca-int-cancelar">Cancelar</button>
      <button class="btn btn-troca-int-salvar">Salvar</button>
    </div>
  </div>`;
  abreModal('Trocar Senha',html);
  document.querySelectorAll('.btn-troca-int-cancelar').forEach(btn=>btn.addEventListener('click',()=>fechaModal(true)));
  document.querySelectorAll('.btn-troca-int-salvar').forEach(btn=>btn.addEventListener('click',()=>executarTrocaSenhaInterno()));
}
window.abreModalTrocarSenhaInterno = abreModalTrocarSenhaInterno;

async function executarTrocaSenhaInterno(){
  if(!currentUser)return;
  const atual=document.getElementById('senhaAtualInt').value.trim();
  const nova1=document.getElementById('novaSenha1Int').value.trim();
  const nova2=document.getElementById('novaSenha2Int').value.trim();
  if(!atual||!nova1||!nova2){alertaModal('Preencha todos os campos de senha.');return;}
  if(currentUser.senha!==atual){alertaModal('Senha atual incorreta.');return;}
  if(nova1!==nova2){alertaModal('Nova senha e confirmação não conferem.');return;}
  currentUser.senha=nova1;
  await fbSet(`users/${currentUser.usuario}`,currentUser);
  fechaModal(true);
  alertaModal('Senha alterada com sucesso.');
}
window.executarTrocaSenhaInterno = executarTrocaSenhaInterno;

// ===== REGISTRAR PEDIDO =====
async function abreModalRegistrarPedido(){
  if(!currentUser||currentUser.perfil==='observador')return;
  const vends = await fbGet('vendedores');
  const pags = await fbGet('pagamentos');
  const selVend=(vends?Object.values(vends):[]).map(v=>`<option value="${v.nome}">${v.nome}</option>`).join('');
  const selPag=(pags?Object.values(pags):[]).map(p=>`<option value="${p.nome}">${p.nome}</option>`).join('');
  
  const html=`<div class="grid gap-3 text-xs">
    <div>
      <label class="small required block mb-1">Nº Pedido</label>
      <input id="rpNumero" class="border border-slate-700 rounded-md px-2 py-1 w-full bg-slate-900 text-slate-100">
    </div>
    <div>
      <label class="small required block mb-1">Vendedor</label>
      <select id="rpVendedor" class="border border-slate-700 rounded-md px-2 py-1 w-full bg-slate-900 text-slate-100">
        <option value="">Selecione...</option>
        ${selVend}
      </select>
    </div>
    <div>
      <label class="small required block mb-1">Cliente</label>
      <input id="rpCliente" style="text-transform:uppercase" class="border border-slate-700 rounded-md px-2 py-1 w-full bg-slate-900 text-slate-100">
    </div>
    <div>
      <label class="small required block mb-1">Valor R$</label>
      <input id="rpValor" class="border border-slate-700 rounded-md px-2 py-1 w-full bg-slate-900 text-slate-100" placeholder="0,00">
    </div>
    <div>
      <label class="small required block mb-1">Pagamento</label>
      <select id="rpPagamento" class="border border-slate-700 rounded-md px-2 py-1 w-full bg-slate-900 text-slate-100">
        <option value="">Selecione...</option>
        ${selPag}
      </select>
    </div>
    <div>
      <label class="small block mb-1">Observações</label>
      <textarea id="rpObs" class="border border-slate-700 rounded-md px-2 py-1 w-full h-16 bg-slate-900 text-slate-100"></textarea>
    </div>
    <div class="text-xs text-slate-300 mt-2">
      * Campos com <span class="text-orange-400">*</span> são obrigatórios.
    </div>
    <div class="flex justify-end gap-2 mt-2">
      <button class="btn-ghost btn-rp-fechar">Fechar</button>
      <button class="btn btn-rp-salvar">Salvar pedido</button>
    </div>
  </div>`;
  abreModal('Registrar Pedido',html);
  
  const numeroInput=document.getElementById('rpNumero');
  const valorInput=document.getElementById('rpValor');
  numeroInput.addEventListener('input',()=>{numeroInput.value=numeroInput.value.replace(/[^0-9]/g,'');});
  valorInput.addEventListener('input',()=>aplicarMascaraMoeda(valorInput));
  
  document.querySelectorAll('.btn-rp-fechar').forEach(btn=>btn.addEventListener('click',()=>fechaModal(true)));
  document.querySelectorAll('.btn-rp-salvar').forEach(btn=>btn.addEventListener('click',()=>salvarNovoPedido()));
}
window.abreModalRegistrarPedido = abreModalRegistrarPedido;

async function salvarNovoPedido(){
  const numero=document.getElementById('rpNumero').value.trim();
  const cliente=document.getElementById('rpCliente').value.trim();
  const vendedor=document.getElementById('rpVendedor').value;
  const valor=parseMoedaToNumber(document.getElementById('rpValor').value);
  const pagamento=document.getElementById('rpPagamento').value;
  let obs=document.getElementById('rpObs').value;
  obs=capitalizarPrimeira(obs);
  
  if(!numero||!cliente||!vendedor||!pagamento){alertaModal('Preencha número, cliente, vendedor e pagamento.');return;}
  if(valor===0){alertaModal('Informe um valor maior que zero.');return;}
  
  window.salvarNovoPedido = salvarNovoPedido;
  
  const pedido={
    numero,
    cliente:cliente.toUpperCase(),
    vendedor,
    valor,
    pagamento,
    observacoes:obs,
    status:'separacao',
    conforme:null,
    dataEntrada:new Date().toISOString(),
    saida:null,
    entregador:null,
    justificativa:'',
    andamentos:[],
    teveNC:false
  };
  
  const newId = await fbPush('pedidos',pedido);
  pedido.id = newId;
  await fbSet(`pedidos/${newId}`,pedido);
  
  fechaModal(true);
  atualizaDashboard();atualizaCardsEntregadores();atualizaListaPedidos();atualizaHistorico();
}

// ===== CONFIGURAÇÕES (ADMIN) =====
async function abreModalConfiguracoes(){
  if(!currentUser||currentUser.perfil!=='admin')return;
  const html=`<div class="flex gap-6 text-xs">
    <div class="w-32 space-y-2 font-semibold">
      <button class="block text-left w-full btn-config-aba" data-aba="usuarios">Usuários</button>
      <button class="block text-left w-full btn-config-aba" data-aba="vendedores">Vendedores</button>
      <button class="block text-left w-full btn-config-aba" data-aba="entregadores">Entregadores</button>
      <button class="block text-left w-full btn-config-aba" data-aba="pagamentos">Formas de Pagamento</button>
    </div>
    <div class="flex-1" id="configContent"></div>
  </div>
  <div class="mt-4 text-right">
    <button class="btn-ghost btn-config-fechar">Fechar</button>
  </div>`;
  abreModal('Configurações',html);
  document.querySelectorAll('.btn-config-aba').forEach(btn=>btn.addEventListener('click',()=>mostrarAbaConfig(btn.dataset.aba)));
  document.querySelectorAll('.btn-config-fechar').forEach(btn=>btn.addEventListener('click',()=>fechaModal(true)));
  mostrarAbaConfig('usuarios');
}
window.abreModalConfiguracoes = abreModalConfiguracoes;

async function mostrarAbaConfig(aba){
  const cont=document.getElementById('configContent');
  if(aba==='usuarios'){
    const users = await fbGet('users');
    let lista='';
    if(users){
      lista=Object.values(users).map(u=>`<div class="flex items-center gap-2 mb-1">
        <span>${u.nome} (${u.usuario}) - ${u.perfil}</span>
        ${u.usuario!=='admin'?`<button class="btn-small btn-ghost btn-excluir-usuario" data-usuario="${u.usuario}">Excluir</button>`:''}
      </div>`).join('');
    }
    if(!lista)lista='<div class="text-slate-400">Sem usuários.</div>';
    cont.innerHTML=`<div class="font-semibold mb-2">Usuários</div>${lista}
    <div class="mt-3"><button class="btn btn-add-usuario">Adicionar Usuário</button></div>`;
    document.querySelectorAll('.btn-excluir-usuario').forEach(btn=>btn.addEventListener('click',async()=>{
      if(!confirm('Confirma excluir?'))return;
      await fbRemove(`users/${btn.dataset.usuario}`);
      mostrarAbaConfig('usuarios');
    }));
    document.querySelectorAll('.btn-add-usuario').forEach(btn=>btn.addEventListener('click',()=>abreModalAddUsuario()));
  }else if(aba==='vendedores'){
    const vends = await fbGet('vendedores');
    let lista='';
    if(vends){
      lista=Object.entries(vends).map(([k,v])=>`<div class="flex items-center gap-2 mb-1">
        <span>${v.nome}</span>
        <button class="btn-small btn-ghost btn-excluir-vendedor" data-id="${k}">Excluir</button>
      </div>`).join('');
    }
    if(!lista)lista='<div class="text-slate-400">Sem vendedores.</div>';
    cont.innerHTML=`<div class="font-semibold mb-2">Vendedores</div>${lista}
    <div class="mt-3"><button class="btn btn-add-vendedor">Adicionar Vendedor</button></div>`;
    document.querySelectorAll('.btn-excluir-vendedor').forEach(btn=>btn.addEventListener('click',async()=>{
      if(!confirm('Confirma excluir?'))return;
      await fbRemove(`vendedores/${btn.dataset.id}`);
      mostrarAbaConfig('vendedores');
      carregaVendedoresSelects();
    }));
    document.querySelectorAll('.btn-add-vendedor').forEach(btn=>btn.addEventListener('click',()=>abreModalAddVendedor()));
  }else if(aba==='entregadores'){
    const ents = await fbGet('entregadores');
    let lista='';
    if(ents){
      lista=Object.entries(ents).map(([k,v])=>`<div class="flex items-center gap-2 mb-1">
        <span>${v.nome}</span>
        <button class="btn-small btn-ghost btn-excluir-entregador" data-id="${k}">Excluir</button>
      </div>`).join('');
    }
    if(!lista)lista='<div class="text-slate-400">Sem entregadores.</div>';
    cont.innerHTML=`<div class="font-semibold mb-2">Entregadores</div>${lista}
    <div class="mt-3"><button class="btn btn-add-entregador">Adicionar Entregador</button></div>`;
    document.querySelectorAll('.btn-excluir-entregador').forEach(btn=>btn.addEventListener('click',async()=>{
      if(!confirm('Confirma excluir?'))return;
      await fbRemove(`entregadores/${btn.dataset.id}`);
      mostrarAbaConfig('entregadores');
    }));
    document.querySelectorAll('.btn-add-entregador').forEach(btn=>btn.addEventListener('click',()=>abreModalAddEntregador()));
  }else if(aba==='pagamentos'){
    const pags = await fbGet('pagamentos');
    let lista='';
    if(pags){
      lista=Object.entries(pags).map(([k,v])=>`<div class="flex items-center gap-2 mb-1">
        <span>${v.nome}</span>
        <button class="btn-small btn-ghost btn-excluir-pagamento" data-id="${k}">Excluir</button>
      </div>`).join('');
    }
    if(!lista)lista='<div class="text-slate-400">Sem formas de pagamento.</div>';
    cont.innerHTML=`<div class="font-semibold mb-2">Formas de Pagamento</div>${lista}
    <div class="mt-3"><button class="btn btn-add-pagamento">Adicionar Forma de Pagamento</button></div>`;
    document.querySelectorAll('.btn-excluir-pagamento').forEach(btn=>btn.addEventListener('click',async()=>{
      if(!confirm('Confirma excluir?'))return;
      await fbRemove(`pagamentos/${btn.dataset.id}`);
      mostrarAbaConfig('pagamentos');
    }));
    document.querySelectorAll('.btn-add-pagamento').forEach(btn=>btn.addEventListener('click',()=>abreModalAddPagamento()));
  }
}
window.mostrarAbaConfig = mostrarAbaConfig;

function abreModalAddUsuario(){
  const html=`<div class="text-xs space-y-2">
    <div><label class="small required block mb-1">Usuário</label><input id="addUsuario" class="border border-slate-700 w-full rounded-md px-2 py-1 bg-slate-900 text-slate-100"></div>
    <div><label class="small required block mb-1">Nome</label><input id="addNomeUser" class="border border-slate-700 w-full rounded-md px-2 py-1 bg-slate-900 text-slate-100"></div>
    <div><label class="small required block mb-1">Senha</label><input id="addSenha" type="password" class="border border-slate-700 w-full rounded-md px-2 py-1 bg-slate-900 text-slate-100"></div>
    <div><label class="small required block mb-1">Perfil</label>
      <select id="addPerfil" class="border border-slate-700 w-full rounded-md px-2 py-1 bg-slate-900 text-slate-100">
        <option value="admin">Admin</option>
        <option value="operador">Operador</option>
        <option value="observador">Observador</option>
      </select>
    </div>
    <div class="flex justify-end gap-2 mt-2">
      <button class="btn-ghost btn-add-user-cancelar">Cancelar</button>
      <button class="btn btn-add-user-salvar">Salvar</button>
    </div>
  </div>`;
  abreModal('Adicionar Usuário',html);
  document.querySelectorAll('.btn-add-user-cancelar').forEach(btn=>btn.addEventListener('click',()=>fechaModal(true)));
  document.querySelectorAll('.btn-add-user-salvar').forEach(btn=>btn.addEventListener('click',async()=>{
    const usuario=document.getElementById('addUsuario').value.trim().toLowerCase();
    const nome=document.getElementById('addNomeUser').value.trim();
    const senha=document.getElementById('addSenha').value.trim();
    const perfil=document.getElementById('addPerfil').value;
    if(!usuario||!nome||!senha){alertaModal('Preencha todos os campos.');return;}
    await fbSet(`users/${usuario}`,{usuario,nome,senha,perfil});
    fechaModal(true);
    mostrarAbaConfig('usuarios');
  }));
}

function abreModalAddVendedor(){
  const html=`<div class="text-xs space-y-2">
    <div><label class="small required block mb-1">Nome do Vendedor</label><input id="addNomeVend" class="border border-slate-700 w-full rounded-md px-2 py-1 bg-slate-900 text-slate-100"></div>
    <div class="flex justify-end gap-2 mt-2">
      <button class="btn-ghost btn-add-vend-cancelar">Cancelar</button>
      <button class="btn btn-add-vend-salvar">Salvar</button>
    </div>
  </div>`;
  abreModal('Adicionar Vendedor',html);
  document.querySelectorAll('.btn-add-vend-cancelar').forEach(btn=>btn.addEventListener('click',()=>fechaModal(true)));
  document.querySelectorAll('.btn-add-vend-salvar').forEach(btn=>btn.addEventListener('click',async()=>{
    const nome=document.getElementById('addNomeVend').value.trim();
    if(!nome){alertaModal('Informe o nome.');return;}
    await fbPush('vendedores',{nome});
    fechaModal(true);
    mostrarAbaConfig('vendedores');
    carregaVendedoresSelects();
  }));
}

function abreModalAddEntregador(){
  const html=`<div class="text-xs space-y-2">
    <div><label class="small required block mb-1">Nome do Entregador</label><input id="addNomeEnt" class="border border-slate-700 w-full rounded-md px-2 py-1 bg-slate-900 text-slate-100"></div>
    <div class="flex justify-end gap-2 mt-2">
      <button class="btn-ghost btn-add-ent-cancelar">Cancelar</button>
      <button class="btn btn-add-ent-salvar">Salvar</button>
    </div>
  </div>`;
  abreModal('Adicionar Entregador',html);
  document.querySelectorAll('.btn-add-ent-cancelar').forEach(btn=>btn.addEventListener('click',()=>fechaModal(true)));
  document.querySelectorAll('.btn-add-ent-salvar').forEach(btn=>btn.addEventListener('click',async()=>{
    const nome=document.getElementById('addNomeEnt').value.trim();
    if(!nome){alertaModal('Informe o nome.');return;}
    await fbPush('entregadores',{nome});
    fechaModal(true);
    mostrarAbaConfig('entregadores');
  }));
}

function abreModalAddPagamento(){
  const html=`<div class="text-xs space-y-2">
    <div><label class="small required block mb-1">Nome da Forma de Pagamento</label><input id="addNomePag" class="border border-slate-700 w-full rounded-md px-2 py-1 bg-slate-900 text-slate-100"></div>
    <div class="flex justify-end gap-2 mt-2">
      <button class="btn-ghost btn-add-pag-cancelar">Cancelar</button>
      <button class="btn btn-add-pag-salvar">Salvar</button>
    </div>
  </div>`;
  abreModal('Adicionar Forma de Pagamento',html);
  document.querySelectorAll('.btn-add-pag-cancelar').forEach(btn=>btn.addEventListener('click',()=>fechaModal(true)));
  document.querySelectorAll('.btn-add-pag-salvar').forEach(btn=>btn.addEventListener('click',async()=>{
    const nome=document.getElementById('addNomePag').value.trim();
    if(!nome){alertaModal('Informe o nome.');return;}
    await fbPush('pagamentos',{nome});
    fechaModal(true);
    mostrarAbaConfig('pagamentos');
  }));
}

// ===== EXPORTAR/IMPRIMIR =====
async function exportarHistoricoCSV(){
  const pedidos = await fbGet('pedidos');
  if(!pedidos){alertaModal('Sem dados para exportar.');return;}
  const lista=Object.values(pedidos);
  let csv='Número;Cliente;Vendedor;Valor;Pagamento;Entrada;Saída;Entregador;Status;Observações;Justificativa\n';
  lista.forEach(p=>{
    csv+=`${p.numero};${p.cliente};${p.vendedor};${p.valor};${p.pagamento};${p.dataEntrada};${p.saida||''};${p.entregador||''};${p.status};${p.observacoes||''};${p.justificativa||''}\n`;
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const link=document.createElement('a');
  link.href=URL.createObjectURL(blob);
  link.download='historico_entregas.csv';
  link.click();
}
window.exportarHistoricoCSV = exportarHistoricoCSV;

function imprimirDashboard(){
  window.print();
}
window.imprimirDashboard = imprimirDashboard;

// ===== LOGIN =====
window.addEventListener('DOMContentLoaded',async()=>{
  await ensureInit();
  
  const inputUser=document.getElementById('loginUser');
  const inputPass=document.getElementById('loginPass');
  const btnLogin=document.getElementById('btnLogin');
  const btnChangePass=document.getElementById('btnChangePass');
  const togglePass=document.getElementById('toggleLoginPass');
  const loginMsg=document.getElementById('loginMsg');
  
  togglePass.addEventListener('click',()=>{
    if(inputPass.type==='password'){inputPass.type='text';togglePass.textContent='Ocultar';}
    else{inputPass.type='password';togglePass.textContent='Mostrar';}
  });
  
  btnLogin.addEventListener('click',()=>executarLogin());
  btnChangePass.addEventListener('click',()=>{
    const u=inputUser.value.trim().toLowerCase();
    if(!u){loginMsg.textContent='Informe usuário e senha.';return;}
    abreModalTrocarSenhaLogin(u);
  });
  
  async function executarLogin(){
    const u=inputUser.value.trim().toLowerCase();
    const s=inputPass.value.trim();
    if(!u||!s){loginMsg.textContent='Informe usuário e senha.';return;}
    
    let user;
    try{
      user = await fbGet(`users/${u}`);
    }catch(e){
      loginMsg.textContent='Erro ao acessar armazenamento local.';return;
    }
    
    if(!user){loginMsg.textContent='Usuário não encontrado.';return;}
    if(user.senha!==s){loginMsg.textContent='Senha incorreta.';return;}
    
    loginMsg.textContent='';
    currentUser=user;
    showApp();
  }
  
  window.executarLogin = executarLogin;
  
  function showApp(){
    document.getElementById('loginView').classList.add('hidden');
    document.getElementById('appView').classList.remove('hidden');
    document.getElementById('userInfo').textContent=`${currentUser.nome} (${currentUser.perfil})`;
    
    if(currentUser.perfil==='admin'){
      document.getElementById('btnHome').classList.remove('hidden');
      document.getElementById('btnConfig').classList.remove('hidden');
      document.getElementById('btnResetDay').classList.remove('hidden');
      document.getElementById('btnResetHistory').classList.remove('hidden');
    }
    
    carregaVendedoresSelects();
    atualizaDashboard();
    atualizaCardsEntregadores();
    atualizaListaPedidos();
  }
  
  document.getElementById('btnHome').addEventListener('click',()=>{
    document.getElementById('appView').classList.remove('hidden');
    document.getElementById('historyView').classList.add('hidden');
  });
  
  document.getElementById('btnHistory').addEventListener('click',()=>{
    document.getElementById('appView').classList.add('hidden');
    document.getElementById('historyView').classList.remove('hidden');
    atualizaHistorico();
  });
  
  document.getElementById('btnBack').addEventListener('click',()=>{
    document.getElementById('appView').classList.remove('hidden');
    document.getElementById('historyView').classList.add('hidden');
  });
  
  document.getElementById('btnConfig').addEventListener('click',()=>abreModalConfiguracoes());
  document.getElementById('btnOpenRegister').addEventListener('click',()=>abreModalRegistrarPedido());
  document.getElementById('btnExport').addEventListener('click',()=>exportarHistoricoCSV());
  document.getElementById('btnPrint').addEventListener('click',()=>imprimirDashboard());
  document.getElementById('btnClearFilters').addEventListener('click',()=>limparFiltrosHistorico());
  
  document.getElementById('btnLogout').addEventListener('click',()=>{
    currentUser=null;
    document.getElementById('appView').classList.add('hidden');
    document.getElementById('historyView').classList.add('hidden');
    document.getElementById('loginView').classList.remove('hidden');
    inputUser.value='';
    inputPass.value='';
    loginMsg.textContent='';
  });
  
  document.getElementById('filterStatus').addEventListener('change',()=>atualizaListaPedidos());
  document.getElementById('filterSeller').addEventListener('change',()=>atualizaListaPedidos());
  document.getElementById('searchInput').addEventListener('input',()=>atualizaListaPedidos());
  
  document.getElementById('historyPeriod').addEventListener('change',()=>atualizaHistorico());
  document.getElementById('historyStart').addEventListener('change',()=>atualizaHistorico());
  document.getElementById('historyEnd').addEventListener('change',()=>atualizaHistorico());
  document.getElementById('historyStatus').addEventListener('change',()=>atualizaHistorico());
  document.getElementById('historySeller').addEventListener('change',()=>atualizaHistorico());
  document.getElementById('historySearch').addEventListener('input',()=>atualizaHistorico());
  
  document.getElementById('btnResetDay').addEventListener('click',async()=>{
    if(!confirm('ATENÇÃO: Isso vai apagar TODOS os pedidos do dia atual. Confirma?'))return;
    const pedidos = await fbGet('pedidos');
    const hoje=new Date().toISOString().slice(0,10);
    if(pedidos){
      for(const [k,p] of Object.entries(pedidos)){
        if(p.dataEntrada?.startsWith(hoje)){
          await fbRemove(`pedidos/${k}`);
        }
      }
    }
    atualizaDashboard();atualizaCardsEntregadores();atualizaListaPedidos();
  });
  
  document.getElementById('btnResetHistory').addEventListener('click',async()=>{
    if(!confirm('ATENÇÃO: Isso vai apagar TODO o histórico de entregas. Confirma?'))return;
    await fbRemove('pedidos');
    atualizaDashboard();atualizaCardsEntregadores();atualizaListaPedidos();atualizaHistorico();
  });
});
</script>
</body>
</html>
